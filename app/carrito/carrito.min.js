(function(){angular.module("bayres.carrito",[]).config(["$routeProvider",function(b){b.when("/carrito",{templateUrl:"carrito/carrito.html",controller:"CarritoController",data:{requiresLogin:true}})}]).controller("CarritoController",a);a.$inject=["$scope","AcUtils","UserService","CartVars","CartService","$location","LinksService","BayresService","UserVars","SucursalService","BayresMailerService"];function a(o,i,l,k,f,g,r,p,b,c,q){var s=this;s.message="";s.detalle="";s.showMensaje=false;s.index=-1;s.carritoDetalles=[];s.sucursales=[];s.tipoEnvios=[{id:1,name:"Envio a"},{id:2,name:"Retira por"}];s.lugarDeEnvios=[{id:1,name:"Gran Buenos Aires"},{id:2,name:"Capital Federal"},{id:3,name:"Interior del Pais"}];s.carritoInfo={cantidadDeProductos:0,totalAPagar:0,modified:false};s.tipoEnvioDefecto=s.tipoEnvios[0];s.lugarDeEnvioDefecto=s.lugarDeEnvios[0];s.confirmado=true;s.removeProducto=e;s.refreshProducto=d;s.confirmCarrito=n;s.getDetalle=h;s.cancelar=m;s.carritoDetalles=(k.carrito.length>0)?k.carrito:p.carrito;s.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();s.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total();c.get(function(t){s.sucursales=t;s.sucursal=t[0]});k.listen(function(){s.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();s.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total()});function m(){s.index=-1;s.detalle="";s.showMensaje=false}function h(u){s.index=u;var t=(k.carrito.length>0)?k.carrito[u]:p.carrito[u];s.detalle=t.nombre+" $"+t.precio_unitario+"(x"+t.cantidad+")"}function e(v){var t=(k.carrito.length>0)?k.carrito[v]:p.carrito[v];var u=[];u.push(t.carrito_detalle_id);f.removeFromCart(u,function(w){if(w!=-1){p.miCarrito.total=k.carrito_total();f.update(p.miCarrito,function(x){if(x){p.messageConfirm="Se quito el producto";m()}else{p.messageConfirm="Error borrando el producto"}p.showMessageConfirm=true});j()}else{p.messageConfirm="Error borrando el producto";p.showMessageConfirm=true}})}function j(){s.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();s.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total();k.broadcast()}function d(t){var u={producto_id:t.producto_id,cantidad:t.cantidad,en_oferta:t.en_oferta,precio_unitario:t.precio_unitario,carrito_id:t.carrito_id,nombre:t.nombre,carrito_detalle_id:t.carrito_detalle_id};f.updateProductInCart(u,function(v){if(v){p.miCarrito.total=k.carrito_total();f.update(p.miCarrito,function(w){if(w){console.log("Update Ok")}else{console.log("Update Error")}});j()}})}function n(){if(k.carrito.length>0){p.miCarrito.total=k.carrito_total();p.miCarrito.status=1;p.miCarrito.origen=s.tipoEnvioDefecto.id;p.miCarrito.destino=(s.tipoEnvioDefecto.id==1)?s.lugarDeEnvioDefecto.id:s.sucursal.sucursal_id;f.update(p.miCarrito,function(u){if(u){p.miCarrito.productos=k.carrito;var t={carrito:p.miCarrito,sucursal:"Sucursal Once"};b.clearCache=true;l.getById(l.getFromToken().data.id,function(v){if(v!=-1){t.direccion=v.direcciones[0].calle+" "+v.direcciones[0].nro;t.cliente=p.usuario.nombre+" "+p.usuario.apellido;t.mail=v.mail;t.tipoEnvio=s.tipoEnvioDefecto.name;t.lugarDeEnvio=(s.tipoEnvioDefecto.id==1)?s.lugarDeEnvioDefecto.name:s.sucursal.nombre;q.sendMailConfirmarCarrito(t,function(w){if(w){p.messageConfirm="Su pedido fue enviado"}else{p.messageConfirm="Error confirmando el carrito"}p.showMessageConfirm=true})}});p.tieneCarrito=false;p.miCarrito={};k.carrito=[];g.path("/main");r.selectedIncludeTop="main/ofertas.html"}else{p.messageConfirm="Error confirmando el carrito";p.showMessageConfirm=true}})}else{s.message="El Carrito esta vacio. Por favor agregue productos";p.messageConfirm="El Carrito esta vacio. Por favor agregue productos";p.showMessageConfirm=true}}}})();