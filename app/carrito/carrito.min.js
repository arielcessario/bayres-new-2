(function(){angular.module("bayres.carrito",[]).config(["$routeProvider",function(b){b.when("/carrito",{templateUrl:"carrito/carrito.html",controller:"CarritoController",data:{requiresLogin:true}})}]).controller("CarritoController",a);a.$inject=["$scope","AcUtils","UserService","CartVars","CartService","$location","LinksService","BayresService","UserVars","SucursalService","BayresMailerService"];function a(o,i,l,k,f,g,s,p,b,c,q){var t=this;t.message="";t.detalle="";t.showMensaje=false;t.index=-1;t.carritoDetalles=[];t.sucursales=[];t.tipoEnvios=[{id:1,name:"Envio a"},{id:2,name:"Retira por"}];t.lugarDeEnvios=[{id:1,name:"Gran Buenos Aires"},{id:2,name:"Capital Federal"},{id:3,name:"Interior del Pais"}];t.carritoInfo={cantidadDeProductos:0,totalAPagar:0,modified:false};t.tipoEnvioDefecto=t.tipoEnvios[0];t.lugarDeEnvioDefecto=t.lugarDeEnvios[0];t.confirmado=true;t.removeProducto=e;t.refreshProducto=d;t.confirmCarrito=n;t.getDetalle=h;t.cancelar=m;t.showDetalle=r;t.carritoDetalles=(k.carrito.length>0)?k.carrito:p.carrito;t.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();t.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total();c.get(function(u){t.sucursales=u;t.sucursal=u[0]});k.listen(function(){t.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();t.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total()});function m(){t.index=-1;t.detalle="";t.showMensaje=false}function h(v){t.index=v;var u=(k.carrito.length>0)?k.carrito[v]:p.carrito[v];t.detalle=u.nombre+" $"+u.precio_unitario+"(x"+u.cantidad+")"}function e(w){var u=(k.carrito.length>0)?k.carrito[w]:p.carrito[w];var v=[];v.push(u.carrito_detalle_id);f.removeFromCart(v,function(x){if(x!=-1){p.miCarrito.total=k.carrito_total();f.update(p.miCarrito,function(y){if(y){p.messageConfirm="Se quito el producto";m()}else{p.messageConfirm="Error borrando el producto"}p.showMessageConfirm=true});j()}else{p.messageConfirm="Error borrando el producto";p.showMessageConfirm=true}})}function j(){t.carritoInfo.cantidadDeProductos=(k.carrito.length>0)?k.carrito_cantidad_productos():p.carrito_cantidad_productos();t.carritoInfo.totalAPagar=(k.carrito.length>0)?k.carrito_total():p.carrito_total();k.broadcast()}function d(u){var v={producto_id:u.producto_id,cantidad:u.cantidad,en_oferta:u.en_oferta,precio_unitario:u.precio_unitario,carrito_id:u.carrito_id,nombre:u.nombre,carrito_detalle_id:u.carrito_detalle_id};f.updateProductInCart(v,function(w){if(w){p.miCarrito.total=k.carrito_total();f.update(p.miCarrito,function(x){if(x){console.log("Update Ok")}else{console.log("Update Error")}});j()}})}function n(){if(k.carrito.length>0){p.miCarrito.total=k.carrito_total();p.miCarrito.status=1;p.miCarrito.origen=t.tipoEnvioDefecto.id;p.miCarrito.destino=(t.tipoEnvioDefecto.id==1)?t.lugarDeEnvioDefecto.id:t.sucursal.sucursal_id;p.messageConfirm="Muchas gracias por su pedido!";p.showMessageConfirm=true;k.broadcast();f.update(p.miCarrito,function(v){if(v){p.miCarrito.productos=k.carrito;var u={carrito:p.miCarrito,sucursal:"Sucursal Once"};b.clearCache=true;l.getById(l.getFromToken().data.id,function(w){if(w!=-1){u.direccion=w.direcciones[0].calle+" "+w.direcciones[0].nro;u.cliente=p.usuario.nombre+" "+p.usuario.apellido;u.mail=w.mail;u.tipoEnvio=t.tipoEnvioDefecto.name;u.lugarDeEnvio=(t.tipoEnvioDefecto.id==1)?t.lugarDeEnvioDefecto.name:t.sucursal.nombre;q.sendMailConfirmarCarrito(u,function(x){if(x){}else{p.messageConfirm="Error confirmando el carrito";p.showMessageConfirm=true;k.broadcast()}})}});p.tieneCarrito=false;p.miCarrito={};k.carrito=[];g.path("/main");s.selectedIncludeTop="main/ofertas.html"}else{p.messageConfirm="Error confirmando el carrito";p.showMessageConfirm=true}})}else{t.message="El Carrito esta vacio. Por favor agregue productos";p.messageConfirm="El Carrito esta vacio. Por favor agregue productos";p.showMessageConfirm=true}}function r(u){s.productId=u;s.showCarrito=true;g.path("/detalle");s.selectedIncludeTop="detalle/detalle.html";p.search=t.search;k.broadcast()}}})();